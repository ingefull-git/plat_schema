version: 2.1

executors:
  python-executor:
    docker:
      - image: circleci/python:3.8
    working_directory: ~/repo

parameters:
  git_tag:
    type: string
    default: ""

jobs:
  take_snapshot:
    executor: python-executor
    parameters:
      version:
        type: string
        default: ""
      schema:
        type: string
        default: ""
    steps:
      - checkout
      - run:
          name: Take Snapshot
          command: |
            mkdir -p snapshots/<< parameters.schema >>
            ./snapshot_schema.sh << parameters.schema >> snapshots/<< parameters.schema >>/snapshot.sql
            if [ -f snapshots/<< parameters.schema >>/snapshot.sql ]; then
              echo "Snapshot taken successfully."
              ls snapshots/<< parameters.schema >>
            else
              echo "Snapshot failed."
              exit 1
            fi
      - persist_to_workspace:
          root: snapshots
          paths:
            - << parameters.schema >>/snapshot.sql

  compare_schemas:
    executor: python-executor
    parameters:
      version:
        type: string
        default: ""
      schema:
        type: string
        default: ""
    steps:
      - checkout
      - attach_workspace:
          at: ./snapshots
      - run:
          name: Compare Schemas
          command: |
            mkdir -p diffs/<< parameters.schema >>
            echo "Current dir: $(pwd)"
            ls diffs/<< parameters.schema >>
            ls snapshots/<< parameters.schema >>
            if ./compare_schema.sh snapshots/<< parameters.schema >>/snapshot.sql backup/<< parameters.schema >>/snapshot.sql diffs/<< parameters.schema >>/schema_diff.sql; then
              echo "No differences found. Continuing deployment."
              rm -rf snapshots
              rm -rf diffs
            else
              rm -rf snapshots
              ls
              echo "Differences found. Creating diff file and commit."
              ls diffs/<< parameters.schema >>
              GIT_USER_NAME=$(git config --get user.name || echo "rulo_ingefull")
              GIT_USER_EMAIL=$(git config --get user.email || echo "rsosa.ingefull@gmail.com")
              echo "Name: $GIT_USER_NAME"
              echo "Mail: $GIT_USER_EMAIL"
              git config --global user.name "$GIT_USER_NAME"
              git config --global user.email "$GIT_USER_EMAIL"
              git add diffs/<< parameters.schema >>/schema_diff.sql
              git commit -m "Found schema differences [ci skip]"
              git push origin $(git rev-parse --abbrev-ref HEAD)
              exit 1
            fi
      
  deploy:
    executor: python-executor
    parameters:
      version:
        type: string
        default: ""
      schema:
        type: string
        default: ""
    steps:
      - checkout
      - attach_workspace:
          at: .
      - setup_remote_docker:
          version: default
      # - add_ssh_keys:
      #     fingerprints:
      #       - "mpwb+fo8b0vSe3cC4/2yEp1GBc6908FGNp/XYj6rJMA"
      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            cd tool_deployer
            pip install -e .
      - run:
          name: Deploy schemas
          command: |
            . venv/bin/activate
            if tool_deployer -e caiso -a deploy -v "<< parameters.version >>" -st all -sch << parameters.schema >> 2>&1 | tee /dev/tty | grep -q 'ERROR'; then
              echo "Deployment failed with errors."
              exit 1
            else
              echo "Deployment succeeded."
            fi
      - run:
          name: Configure git
          command: |
            GIT_USER_NAME=$(git config --get user.name || echo "rulo_ingefull")
            GIT_USER_EMAIL=$(git config --get user.email || echo "rsosa.ingefull@gmail.com")
            echo "Name: $GIT_USER_NAME"
            echo "Mail: $GIT_USER_EMAIL"
            git config --global user.name "$GIT_USER_NAME"
            git config --global user.email "$GIT_USER_EMAIL"
      - run:
          name: Take Post-deployment Snapshot
          command: |
            ./snapshot_schema.sh << parameters.schema >> backup/<< parameters.schema >>/snapshot.sql
      - run:
          name: Commit schema changes
          command: |
            echo "Git status:"
            git add << parameters.schema >> backup/<< parameters.schema >>
            git status
            git commit -m "Updated plan files and schema snapshot [ci skip]"
            git push origin $(git rev-parse --abbrev-ref HEAD)
      # - run:
      #     name: Debug and Push changes
      #     command: |
      #       echo "Current branch: $(git rev-parse --abbrev-ref HEAD)"
      #       echo "Git status:"
      #       git status
      #       echo "Pushing changes..."
      #       git push origin $(git rev-parse --abbrev-ref HEAD)
      # - run:
      #     name: Clean Repository
      #     command: |
      #       ls
      #       rm -rf diffs
      #       rm -rf snapshots/<< parameters.schema >>
      #       git commit -am "Clean up after deployment [ci skip]"
      #       git push origin $(git rev-parse --abbrev-ref HEAD)

workflows:
  version: 2
  deploy_on_tag:
    jobs:
      - take_snapshot:
          schema: platform
          context: cicd
      - compare_schemas:
          requires:
            - take_snapshot
          schema: platform
          context: cicd
      - deploy:
          requires:
            - compare_schemas
          filters:
          #   branches:
          #     only: master
            tags:
              only: /^v.*/
          version: v0.1.2
          schema: platform
          context: cicd
      # - commit_and_push:
      #     requires:
      #       - deploy
      #     filters:
      #       tags:
      #         only: /^v.*/